@page "/zadanie"
@rendermode InteractiveServer

<MyMudProviders />

<PageTitle>Zadanie</PageTitle>

<MudDropContainer T="DropItem" Items="_items" ItemIsDisabled="@( (item) => item.Disabled)" ItemsSelector="@((item,dropzone) => item.Selector == dropzone)" ItemDropped="ItemUpdated" ItemPicked="ItemPicked" Class="d-flex flex-wrap h-screen">
    <ChildContent>
        <MudGrid>
            <MudPaper>
                <MudList Clickable="true" Class="d-flex flex-column">
                    <MudListSubheader>Użytkownicy</MudListSubheader>
                    <MudDropZone T="DropItem" Identifier="0" Class="flex-grow-1" />
                </MudList>
                <MudPaper>
                    <MudStack Class="overflow-y-scroll">
                        @for(int i = Logs.Count - 1; i >= 0; --i)
                        {
                            int index = i;
                            <MudChip Class="justify-start" Icon="@GetIcon(Logs[index].ContainerIndex)" Variant="Variant.Text" Color="Color.Primary">@CreateLogMessage(Logs[index].Item.Item, Logs[index].ContainerIndex, Logs[index].Action)</MudChip>
                        }
                    </MudStack>
                </MudPaper>
            </MudPaper>
            <MudTabs Outlined="true">
                <MudTabPanel Text="Grupa 1" Icon="@Icons.Material.Filled.Star">
                    <ChildContent>
                        <MudPaper Class="flex-grow-1">
                            <MudList Clickable="true" Class="d-flex flex-column mud-height-full">
                                <MudDropZone T="DropItem" Identifier="1" Class="flex-grow-1" />
                             </MudList>
                        </MudPaper>
                    </ChildContent>
                </MudTabPanel>
                <MudTabPanel Text="Grupa 2" Icon="@Icons.Material.Filled.Square">
                    <ChildContent>
                        <MudPaper Class="flex-grow-1">
                            <MudList Clickable="true" Class="d-flex flex-column mud-height-full">
                                <MudDropZone T="DropItem" Identifier="2" Class="flex-grow-1" />
                            </MudList>
                        </MudPaper>
                    </ChildContent>
                </MudTabPanel>
                <MudTabPanel Text="Grupa 3" Icon="@Icons.Material.Filled.InsertEmoticon">
                    <ChildContent>
                        <MudPaper Class="flex-grow-1">
                            <MudList Clickable="true" Class="d-flex flex-column mud-height-full">
                                <MudDropZone T="DropItem" Identifier="3" Class="flex-grow-1" />
                            </MudList>
                        </MudPaper>
                    </ChildContent>
                </MudTabPanel>
                <MudTabPanel Text="Grupa 4" Icon="@Icons.Material.Filled.Circle">
                    <ChildContent>
                        <MudPaper Class="flex-grow-1">
                            <MudList Clickable="true" Class="d-flex flex-column mud-height-full">
                                <MudDropZone T="DropItem" Identifier="4" Class="flex-grow-1" />
                            </MudList>
                        </MudPaper>
                    </ChildContent>
                </MudTabPanel>
                <MudTabPanel Text="Grupa 5" Icon="@Icons.Material.Filled.ChangeHistory">
                    <ChildContent>
                        <MudPaper Class="flex-grow-1">
                            <MudList Clickable="true" Class="d-flex flex-column mud-height-full">
                                <MudDropZone T="DropItem" Identifier="5" Class="flex-grow-1" />
                            </MudList>
                        </MudPaper>
                    </ChildContent>
                </MudTabPanel>
            </MudTabs>
        </MudGrid>
    </ChildContent>
    <ItemRenderer>
        <MudListItem Text="@context.Name" Disabled="@(context.Disabled)" />
    </ItemRenderer>
</MudDropContainer>

@code {
    private void ItemUpdated(MudItemDropInfo<DropItem> dropItem)
    {
        if (dropItem.DropzoneIdentifier == previousContainerIndex) 
        {
            return;
        }

        dropItem.Item.Selector = dropItem.DropzoneIdentifier;

        if (previousContainerIndex != "0")
        {
            Logs.Add(new LogItem(dropItem, previousContainerIndex, ActionType.Removed));
        }

        if (dropItem.DropzoneIdentifier != "0")
        {
            Logs.Add(new LogItem(dropItem, dropItem.DropzoneIdentifier, ActionType.Added));
        }
    }

    private void ItemPicked(MudDragAndDropItemTransaction<DropItem> dropItem)
    {
        previousContainerIndex = dropItem.SourceZoneIdentifier;
    }

    private List<DropItem> _items = new()
    {
        new DropItem(){ Name = "Item 1", Sex = Sex.Male, Selector = "0" },
        new DropItem(){ Name = "Item 2", Sex = Sex.Female, Selector = "0" },
        new DropItem(){ Name = "Item 3", Sex = Sex.Female, Selector = "0", Disabled = true },
        new DropItem(){ Name = "Item 4", Sex = Sex.Other, Selector = "0" },
        new DropItem(){ Name = "Item 5", Sex = Sex.Male, Selector = "0" },
    };

    private List<LogItem> Logs = new();

    private string previousContainerIndex = string.Empty;

    private class DropItem
    {
        public string Name { get; init; }
        public Sex Sex { get; init; }
        public string Selector { get; set; }
        public bool Disabled { get; set; } = false;
    }

    private record LogItem(MudItemDropInfo<DropItem> Item, string ContainerIndex, ActionType Action);

    private string CreateLogMessage(DropItem item, string containerIndex, ActionType action)
    {
        return $"Użytkownik {item.Name} {StringHelpers.CreateActionTypeMessage(action, item.Sex)} grupy {containerIndex}!";
    }

    private string GetIcon(string containerIndex)
    {
        switch(containerIndex)
        {
            case "1":
                return Icons.Material.Filled.Star;
            case "2":
                return Icons.Material.Filled.Square;
            case "3":
                return Icons.Material.Filled.InsertEmoticon;
            case "4":
                return Icons.Material.Filled.Circle;
            case "5":
                return Icons.Material.Filled.ChangeHistory;
            default:
                return Icons.Material.Filled.Dangerous;                
        }
    }
}